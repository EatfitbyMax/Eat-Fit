entrypoint = "README.md"
modules = ["nodejs-20"]

[nix]
channel = "stable-24_05"

[[ports]]
localPort = 80
externalPort = 80

[workflows]
runButton = "Dev avec VPS"

[[workflows.workflow]]
name = "Dev Server"
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "EXPO_PACKAGER_PROXY_URL=https://$REPLIT_DEV_DOMAIN REACT_NATIVE_PACKAGER_HOSTNAME=$REPLIT_DEV_DOMAIN npx expo start"

[[workflows.workflow]]
name = "EAS Init"
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "npx eas init"

[[workflows.workflow]]
name = "EAS Update"
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "npx eas update --auto"

[[workflows.workflow]]
name = "EAS Publish Preview iOS"
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "npx eas build --platform ios --profile preview"

[[workflows.workflow]]
name = "EAS Publish Preview Android"
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "npx eas build --platform android --profile preview"

[[workflows.workflow]]
name = "Serveur API"
author = 42598128
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "cd server && npm install && node server.js"

[[workflows.workflow]]
name = "Serveur OVH Local"
author = 42598128
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "cd server && npm start"

[[workflows.workflow]]
name = "Dev Full Stack"
author = 42598128
mode = "parallel"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "EXPO_PACKAGER_PROXY_URL=https://$REPLIT_DEV_DOMAIN REACT_NATIVE_PACKAGER_HOSTNAME=$REPLIT_DEV_DOMAIN npx expo start"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "cd server && node server.js"

[[workflows.workflow]]
name = "EAS Build Production iOS"
author = 42598128
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "npx eas build --platform ios --profile production --non-interactive"

[[workflows.workflow]]
name = "EAS Submit App Store"
author = 42598128
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "npx eas submit --platform ios --profile production --non-interactive"

[[workflows.workflow]]
name = "DÃ©ploiement Production"
author = 42598128
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "cd server && npm install --production"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "cd server && npm start"

[[workflows.workflow]]
name = "Deploy to VPS"
author = 42598128
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "node scripts/deploy-to-vps.js"

[[workflows.workflow]]
name = "Dev avec VPS"
author = 42598128
mode = "parallel"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "EXPO_PUBLIC_API_URL=http://51.178.29.220:5000 EXPO_PACKAGER_PROXY_URL=https://$REPLIT_DEV_DOMAIN REACT_NATIVE_PACKAGER_HOSTNAME=$REPLIT_DEV_DOMAIN npx expo start"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "ssh ubuntu@51.178.29.220 \"cd /home/ubuntu/eatfitbymax-server && pm2 logs eatfitbymax-server --lines 50\""

[[workflows.workflow]]
name = "Dev avec Fallback"
author = 42598128
mode = "parallel"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "EXPO_PUBLIC_API_URL=http://51.178.29.220:5000 EXPO_PUBLIC_REPLIT_URL=https://workspace-eatfitbymax.replit.dev EXPO_PACKAGER_PROXY_URL=https://$REPLIT_DEV_DOMAIN REACT_NATIVE_PACKAGER_HOSTNAME=$REPLIT_DEV_DOMAIN npx expo start"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "cd server && npm install && node server.js"

[[workflows.workflow]]
name = "Test Deployment"
author = 42598128
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "cd server && node server.js"

[[workflows.workflow]]
name = "Build iOS Production"
author = 42598128
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "npx eas build --platform ios --profile production --non-interactive"

[[workflows.workflow]]
name = "Submit to App Store"
author = 42598128
mode = "sequential"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "npx eas submit --platform ios --profile production --non-interactive"

[deployment]
run = ["sh", "-c", "cd server && node server.js"]
